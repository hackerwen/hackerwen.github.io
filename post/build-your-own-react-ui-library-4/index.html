<html>
  <head>
  <meta
    name="viewport"
    content="width=device-width,minimum-scale=1,maximum-scale=1,initial-scale=1,user-scalable=no"
  />
  <meta charset="utf-8" />
  <meta name="referrer" content="never" />
  <title>React 组件库搭建指南-单元测试 | 海秋</title>
  <link rel="stylesheet" href="https://cdn.staticfile.org/KaTeX/0.11.1/katex.min.css" />
  <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://worldzhao.github.io/styles/main.css" />
  <script src="https://worldzhao.github.io/media/scripts/mdui.min.js"></script>
  <link rel="stylesheet" href="https://at.alicdn.com/t/font_1306644_jwtuc2zzbrd.css" />
  <link
    href="https://fonts.googleapis.com/css?family=Dancing+Script|Ma+Shan+Zheng&display=swap"
    rel="stylesheet"
  />
  <script src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>
  <script src="https://worldzhao.github.io/media/scripts/script.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>

  
</head>

    <body class="mdui-theme-primary-purple mdui-theme-accent-purple">
        <header class="index-img mdui-m-b-3"  style="background-image: url(https://tva1.sinaimg.cn/large/0082zybpgy1gbte6g8049j30u00u0kjm.jpg);" >
                          <button class="mdui-btn  mdui-btn-icon mdui-btn-dense mdui-color-theme-500 mdui-ripple yinying mdui-m-t-1 mdui-m-l-1" mdui-menu="{target: '#demo-attr-cascade'}"><i class="mdui-icon material-icons">&#xe5d2;</i></button>
                <ul class="mdui-menu" id="demo-attr-cascade">
                
                        <li class="mdui-menu-item">
                          <a href="/" class="mdui-ripple">首页</a>
                        </li>
                
                        <li class="mdui-menu-item">
                          <a href="/archives" class="mdui-ripple">归档</a>
                        </li>
                
                        <li class="mdui-menu-item">
                          <a href="/tags" class="mdui-ripple">标签</a>
                        </li>
                
                        <li class="mdui-menu-item">
                          <a href="/post/about" class="mdui-ripple">关于</a>
                        </li>
                
                      </ul>

        </header>
        <div class="mdui-container post">
                <div class="mdui-row">
                        <div class="mdui-col-md-8 mdui-col-offset-md-2 ">
                         <article class="mdui-shadow-10 mdui-p-a-2 post-list">
                           <div class="mdui-typo-display-1 mdui-m-b-3">React 组件库搭建指南-单元测试</div>
                           <a  class="index-list-biaoqian ">2020-02-12</a>
                           <div class="mdui-typo mdui-m-t-3 post-neirong"><p>与软件操作行为越接近的测试，越能给予你信心。</p>
<!--more -->
<ul>
<li><a href="https://juejin.im/post/5df9a39f6fb9a0165b4cdb26">React 组件库搭建指南-准备工作</a></li>
<li><a href="https://juejin.im/post/5dfb09b1e51d4558096d5f94">React 组件库搭建指南-开发调试</a></li>
<li><a href="https://juejin.im/post/5e030b926fb9a0162c487c7b">React 组件库搭建指南-打包输出</a></li>
<li><a href="https://juejin.im/post/5e23e4035188252c6c478665">React 组件库搭建指南-单元测试</a></li>
</ul>
<h2 id="概览">概览</h2>
<p>本节主要讲述如何在组件库中引入<a href="https://jestjs.io/">jest</a>以及<a href="https://testing-library.com/docs/react-testing-library/intro">@testing-library/react</a>，而不会深入单元测试的学习。</p>
<p>如果你对下列问题感兴趣：</p>
<ol>
<li>What-单元测试是什么？</li>
<li>Why-为什么要写单元测试？</li>
<li>How-编写单元测试的最佳实践？</li>
</ol>
<p>那么可以看看以下文章：</p>
<ul>
<li><a href="https://thomlom.dev/test-react-testing-library/">Test React apps with React Testing Library</a>：通过一个<code>&lt;Counter /&gt;</code>的例子延伸，阐述了选择<code>React Testing Library</code>而非<code>Enzyme</code>的理由，并对其进行了一些入门教学；</li>
<li><a href="https://testing-library.com/docs/react-testing-library/intro">React Testing Library</a>：<code>@testing-library/react</code>的官方文档，该库提供的 API 在某个程度上就是在指引开发者进行单元测试的最佳实践；</li>
<li><a href="https://testing-library.com/docs/recipes">React Testing Library-examples</a>：<code>@testing-library/react</code>的一些实例，提供了各种常见场景的测试；</li>
<li><a href="https://github.com/linesh-simplicity/linesh-simplicity.github.io/issues/200">React 单元测试策略及落地</a>：如标题所示，值得一看。</li>
</ul>
<p>本节所有代码可在仓库<a href="https://github.com/worldzhao/react-ui-library-tutorial/tree/chapter-4/test">chapter-4</a>分支中获取。</p>
<h2 id="相关配置">相关配置</h2>
<p>安装依赖：</p>
<pre><code class="language-bash">yarn add jest ts-jest @testing-library/react @testing-library/jest-dom identity-obj-proxy @types/jest @types/testing-library__react --dev
</code></pre>
<ul>
<li><a href="https://jestjs.io/">jest</a>: JavaScript 测试框架，专注于简洁明快；</li>
<li><a href="https://github.com/kulshekhar/ts-jest">ts-jest</a>：为<code>TypeScript</code>编写<code>jest</code>测试用例提供支持；</li>
<li><a href="https://testing-library.com/docs/react-testing-library/intro">@testing-library/react</a>：简单而完整的<code>React DOM</code>测试工具，鼓励良好的测试实践；</li>
<li><a href="https://testing-library.com/docs/ecosystem-jest-dom">@testing-library/jest-dom</a>：自定义的<code>jest</code>匹配器(<code>matchers</code>)，用于测试<code>DOM</code>的状态（即为<code>jest</code>的<code>except</code>方法返回值增加更多专注于<code>DOM</code>的<code>matchers</code>）；</li>
<li><a href="https://www.npmjs.com/package/identity-obj-proxy">identity-obj-proxy</a>：一个工具库，此处用来<code>mock</code>样式文件。</li>
</ul>
<p>新建<code>jest.config.js</code>，并写入相关配置，更多配置可参考<a href="https://jestjs.io/docs/en/configuration">jest 官方文档-配置</a>，只看几个常用的就可以。</p>
<p><strong>jest.config.js</strong></p>
<pre><code class="language-js">module.exports = {
  verbose: true,
  roots: ['&lt;rootDir&gt;/components'],
  moduleNameMapper: {
    '\\.(css|less|scss)$': 'identity-obj-proxy',
    '^components$': '&lt;rootDir&gt;/components/index.tsx',
    '^components(.*)$': '&lt;rootDir&gt;/components/$1',
  },
  testRegex: '(/test/.*|\\.(test|spec))\\.(ts|tsx|js)$',
  moduleFileExtensions: ['ts', 'tsx', 'js', 'jsx'],
  testPathIgnorePatterns: ['/node_modules/', '/lib/', '/esm/', '/dist/'],
  preset: 'ts-jest',
  testEnvironment: 'jsdom',
};
</code></pre>
<p>修改<code>package.json</code>，增加测试相关命令，并且代码提交前，跑测试用例，如下：</p>
<p><strong>package.json</strong></p>
<pre><code class="language-diff">&quot;scripts&quot;: {
  ...
+  &quot;test&quot;: &quot;jest&quot;,                         # 执行jest
+  &quot;test:watch&quot;: &quot;jest --watch&quot;,           # watch模式下执行
+  &quot;test:coverage&quot;: &quot;jest --coverage&quot;,     # 生成测试覆盖率报告
+  &quot;test:update&quot;: &quot;jest --updateSnapshot&quot;  # 更新快照
},
...
&quot;lint-staged&quot;: {
  &quot;components/**/*.ts?(x)&quot;: [
    &quot;prettier --write&quot;,
    &quot;eslint --fix&quot;,
+   &quot;jest --bail --findRelatedTests&quot;,
    &quot;git add&quot;
  ],
  ...
}
</code></pre>
<p>修改<code>gulpfile.js</code>以及<code>tsconfig.json</code>，避免打包时，把测试文件一并处理了。</p>
<p><strong>gulpfile.js</strong></p>
<pre><code class="language-diff">const paths = {
  ...
- scripts: ['components/**/*.{ts,tsx}', '!components/**/demo/*.{ts,tsx}'],
+ scripts: [
+   'components/**/*.{ts,tsx}',
+   '!components/**/demo/*.{ts,tsx}',
+   '!components/**/__tests__/*.{ts,tsx}',
+ ],
};
</code></pre>
<p><strong>tsconfig.json</strong></p>
<pre><code class="language-diff">{
- &quot;exclude&quot;: [&quot;components/**/demo&quot;]
+ &quot;exclude&quot;: [&quot;components/**/demo&quot;, &quot;components/**/__tests__&quot;]
}
</code></pre>
<h2 id="编写测试用例">编写测试用例</h2>
<p><code>&lt;Alert /&gt;</code>比较简单，此处只作示例用，简单进行一下快照测试。</p>
<p>在对应组件的文件夹下新建<code>__tests__</code>文件夹，用于存放测试文件，其内新建<code>index.test.tsx</code>文件，写入以下测试用例：</p>
<p><strong>components/alert/<strong>tests</strong>/index.test.tsx</strong></p>
<pre><code class="language-jsx">import React from 'react';
import { render } from '@testing-library/react';
import Alert from '../alert';

describe('&lt;Alert /&gt;', () =&gt; {
  test('should render default', () =&gt; {
    const { container } = render(&lt;Alert&gt;default&lt;/Alert&gt;);
    expect(container).toMatchSnapshot();
  });

  test('should render alert with type', () =&gt; {
    const kinds: any[] = ['info', 'warning', 'positive', 'negative'];

    const { getByText } = render(
      &lt;&gt;
        {kinds.map(k =&gt; (
          &lt;Alert kind={k} key={k}&gt;
            {k}
          &lt;/Alert&gt;
        ))}
      &lt;/&gt;,
    );

    kinds.forEach(k =&gt; {
      expect(getByText(k)).toMatchSnapshot();
    });
  });
});
</code></pre>
<p>更新一下快照：</p>
<pre><code class="language-bash">yarn test:update
</code></pre>
<p>可以看见同级目录下新增了一个<code>__snapshots__</code>文件夹，里面存放对应测试用例的快照文件。</p>
<figure data-type="image" tabindex="1"><img src="https://user-gold-cdn.xitu.io/2020/1/19/16fbc32a99857807?w=1728&amp;h=974&amp;f=jpeg&amp;s=144346" alt="生成的快照文件" loading="lazy"></figure>
<p>再执行测试用例：</p>
<pre><code class="language-bash">yarn test
</code></pre>
<figure data-type="image" tabindex="2"><img src="https://user-gold-cdn.xitu.io/2020/1/19/16fbc32a98f22f73?w=1112&amp;h=518&amp;f=jpeg&amp;s=59424" alt="通过测试用例" loading="lazy"></figure>
<p>可以发现我们通过了测试用例。。。额，这里当然能通过，主要是后续我们进行迭代重构时，都会重新执行测试用例，与最近的一次快照进行比对，如果与快照不一致（结构发生了改变），那么相应的测试用例就无法通过。</p>
<p>对于快照测试，褒贬不一，这个例子也着实简单得很，甚至连扩展的 <code>jest-dom</code>提供的 <code>matchers</code> 都没用上，如何编写优秀的测试用例，我也是一个新手，只能说多看多写多尝试，概述推荐的文章很不错。</p>
<p>本文如有错误，恳请指正，共同交流学习。</p>
<p>To be Continued...</p>
</div>
                              <div class="mdui-divider mdui-m-t-3"></div>
                              <div class="mdui-row-xs-2 mdui-m-t-2">
  <div class="mdui-col"> </div>
 <div class="mdui-col"><div class="mdui-text-right "><a href="https://worldzhao.github.io/post/build-your-own-react-ui-library-3">React 组件库搭建指南-打包输出</a></div> </div>
                                </div>
                                <div class="mdui-divider mdui-m-t-2"></div>
   
          
            <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<div id="gitalk-container"></div>

<script>

  var gitalk = new Gitalk({
    clientID: 'ae70790f8df61d7ce952',
    clientSecret: 'dba663050bbe1ab7a23296198c9728128461dc35',
    repo: 'worldzhao.github.io',
    owner: 'worldzhao',
    admin: ['worldzhao'],
    id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
  })

  gitalk.render('gitalk-container')

</script>

          

          
        
 <script src="https://worldzhao.github.io/media/scripts/Valine.min.js"></script>
 <div class="comment"></div>

<script>
      new Valine({
            el: '.comment',



            path: window.location.pathname,
            pageSize: 30,
            avatar:'mm', 
       })

    </script> 
<script>
    if(window.location.hash){
        var checkExist = setInterval(function() {
           if ($(window.location.hash).length) {
              $('html, body').animate({scrollTop: $(window.location.hash).offset().top-90}, 1000);
              clearInterval(checkExist);
           }
        }, 100);
    }
</script>
                         </article>
                 <div class="toc-container mdui-float-right">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E6%A6%82%E8%A7%88">概览</a></li>
<li><a href="#%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE">相关配置</a></li>
<li><a href="#%E7%BC%96%E5%86%99%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B">编写测试用例</a></li>
</ul>
</li>
</ul>

              </div>

                        </div>
                 </div>
          
        </div>
        <script data-no-instant>
    (function ($) {
        $.extend({
            adamsOverload: function () {
                $.viewImage({
                    'target'  : '.post-neirong img',
                    'exclude' : '.vsmile-icons img , .song-links-item img',
                    'delay'   : 300
                });
            }
        });
    })(jQuery);
    jQuery.adamsOverload();
</script>
        <footer class="footer mdui-m-t-5 mdui-text-center">
               <nav class="social-links">
                      <ul>
                      
                            
                           
                            
                           
                            	
                        <li class="social-link"><a href="https://github.com/worldzhao" target="_blank"><i class="iconfont icon-github"></i></a></li>
                         
                           
                            	
                        <li class="social-link"><a href="https://www.zhihu.com/people/zhao-qing-90-84/activities" target="_blank"><i class="iconfont icon-zhihu"></i></a></li>
                         
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                      </ul>
                    </nav>
                    <div class="copyright">
                      <p>Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> <br/> Theme <a href="https://github.com/shanbufun/gridea-theme-jia" target="_blank"  title="佳"  >Jia</a> by <a href="https://shanbu.fun/" target="_blank"  title="山卜方" >Shanbufun</a> </p>
                  </div>
              </footer>
    </body>
</html>